function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}();define("platformInit/utils/appsUtils",["lodash"],function(e){"use strict";function t(t,r){return e(r).map(function(e){return t.getDynamicPageData(e)}).find()}function r(r,i,n){if(r){var o=t(r,n);if(o){var s=o.routerData,a=o.routerDefinition;if(s&&a)if("wix-code"===a.appDefinitionId)e.forEach(n,function(t){e.forEach(i,function(e){e.id===t&&(e.routerData=s)})});else{var u=e.find(i,{id:a.appDefinitionId});u&&(u.routerData=s)}}}}function i(t){return e(t).reject({displayName:"siteextension"}).map(function(t){return e.assign({type:h.APPLICATION},t)}).value()}function n(t){return!!e.get(t,["wixCodeModel","appData","codeAppId"])}function o(t){return e.some(t.widgets,{componentFields:{semiNative:!0}})}function s(t,r,i,o,s){if(n(o.rendererModel)&&e.find(t,r)){var a=o.isPlatformAppOnPage("masterPage","wixCode");e.forEach(i,function(t){var r=o.isPlatformAppOnPage(t,"wixCode"),i=o.getDataByQuery(t),n=e.get(i,"isPopup");r&&s.push({id:t,type:n?h.POPUP:h.PAGE,displayName:o.getPageTitle(t)}),!n&&a&&s.push({id:t,type:h.MASTER_PAGE})})}}function a(t,n,o){t=e.without(t,"masterPage");var a=i(o);return s(o,{displayName:"siteextension"},t,n,a),r(n,a,t),a}function u(){for(var e=arguments[0],t=1;t<arguments.length;++t)e=e.replace(/\/$/,"")+"/"+arguments[t].replace(/^\//,"");return e}function c(e,t,r){var i=u(e.scriptsDomainUrl,"services",t);return r?u(i,r):e.scriptsLocationMap[t]}function l(t,r,i){if(e.get(t,"port")&&e.get(t,"path")&&e.get(t,"id")){i=e.endsWith(i,"/")?i.slice(0,-1):i;var n=e.template("<%= santaBase %><%= port %>/<%= path %>"),o=void 0;o=/^(http(s)?:)?\/\//.test(t.path)?t.path:n("80"===t.port?{santaBase:i,port:"",path:t.path}:{santaBase:i,port:":"+t.port,path:t.path}),r.push({type:h.APPLICATION,id:t.id,url:o,displayName:t.id})}}function d(t,r,i,o,s){n(s)&&e.find(t,{type:"siteextension"})&&!e.find(r,{id:"dataBinding"})&&r.push({type:h.APPLICATION,id:"dataBinding",url:u(c(i,"dbsm-viewer-app",o.dataBinding),"/app.js"),hasSemiNativeWidgets:!1,displayName:"Data Binding"})}function p(t,r){return e(t).filter(function(t){return n(r)&&"siteextension"===t.type||e.has(t,"appFields.platform.viewerScriptUrl")}).map(function(t){var r={id:t.appDefinitionId,displayName:t.type,appInnerId:t.applicationId,instance:t.instance},i=e.get(t,"appFields.platform.viewerScriptUrl");return i&&(r.url=i),r.hasSemiNativeWidgets=o(t),r}).value()}function f(e){var t=p(e.clientSpecMap,e.rendererModel),r=m(e.viewerPlatformAppSources);return l(r,t,e.santaBase),d(e.clientSpecMap,t,e.serviceTopology,r,e.rendererModel),t}function g(t,r,i){return a(r,i,f({clientSpecMap:t,viewerPlatformAppSources:e.get(i,["currentUrl","query","viewerPlatformAppSources"]),serviceTopology:i.serviceTopology,santaBase:i.santaBase,rendererModel:i.rendererModel}))}function m(t){return e(t||"").split(",").invokeMap("split",/:(.+)/).fromPairs().value()}var h={POPUP:"Popup",PAGE:"Page",MASTER_PAGE:"masterPage",APPLICATION:"Application"};return{getApplications:g,getUserCodeDefinitions:function(t,r,i){return e.reject(g(t,r,i),{type:h.APPLICATION})},getAppsBaseInfo:function(t){var r=f(t);return e.filter(i(r),"url")}}}),define("platformInit/utils/widgetsPreLoader",["platformInit/utils/appsUtils"],function(e){"use strict";function t(e,t,u,c){if(i())return a.push([e,t,u,c]),void requirejs(["utils","widgets","wixCode"],r);var l=c(n);l.currentUrl=n.urlUtils.parseUrl(e);var d=n.wixUrlParser.parseUrl(l,e),p=d&&d.pageId;if(p){var f=t(o,l,p),g=s.wixCodeWidgetService.getWixCodeSpec(l.getClientSpecMap());u(s.messageBuilder.getExtendedMessage(f,l.rendererModel.wixCodeModel||{},g,l))}}function r(e,r,u){i()&&(n=e,o=r,s=u,a.forEach(function(e){return t.apply(void 0,_toConsumableArray(e))}),a.length=0)}function i(){return!n||!o||!s}var n=null,o=null,s=null,a=[];return{asyncGetPreLoadMessage:function(r,i,n){t(i,function(t,i,n){var o=e.getApplications(r.rendererModel.clientSpecMap,[n],i),s=r.routers||{configMap:{}};return t.messageBuilder.loadWidgetsMessage(o,s.configMap,[n])},n,function(e){return new e.FullSiteData(r,function(){})})},asyncGetPreLoadUserCodeMessage:function(r,i,n){t(i,function(t,i,n){var o=e.getUserCodeDefinitions(r.rendererModel.clientSpecMap,[n],i);return t.messageBuilder.loadUserCodesMessage(o,[n])},n,function(e){return new e.FullSiteData(r,function(){})})},asyncGetPreInitMessage:function(e,r,i){t(r,function(e,t,r){var i={};return i[r]=e.widgetService.getContextInitData(t,r),e.messageBuilder.initWidgetsMessage(i)},i,function(){return e})},registerDeps:r}}),define("platformInit/utils/constants",[],function(){"use strict";return{APPS:{SANTA_MEMBERS:{appDefId:"14cc59bc-f0b7-15b8-e1c7-89ce41d0e0c9"},FORM_BUILDER:{appDefId:"14ce1214-b278-a7e4-1373-00cebd1bef7c"}},ES6_RUNTIME_PATH:"/es6runtime.min.js",WIX_CODE_RUNTIME_PATH:"/all.min.js",DATA_BINDING:"dataBinding",REMOTE_DOM_URL:"//unpkg.parastorage.com/@shimil/remote-dom@3.0.3/dist/remote.min.js",SEMI_NATIVE_SDK_URL:"http://static.parastorage.com/services/semi-native-sdk/1.3.0/lib/wix.min.js",PM_RPC_INTENTS:{INVOKE:"invoke",RPC_RESOLVE:"rpc-resolve",RPC_REJECT:"rpc-reject",API_DESCRIPTION:"api-desc",INVOKE_FUNCTION:"invoke-func",RESOLVE:"resolve",REJECT:"reject",REQUEST_API:"request-api"}}}),define("platformInit/utils/cookieUtils",[],function(){"use strict";function e(e){for(var t={},r=e.split(/;\s*/),i=0,n=r.length;i<n;i++){var o=r[i].split("=");t[o[0]]=o[1]}return t}return{getCookie:function(t){if("undefined"!=typeof document)return e(window.document.cookie)[t]}}}),define("platformInit/utils/wixCodeUrlUtils",["lodash","platformInit/utils/cookieUtils"],function(e,t){"use strict";function r(e){var t=e.appConfig.userScript;return{id:e.id,url:t.url,scriptName:t.scriptName,displayName:t.displayName,routerData:e.routerData}}function i(t){return e(t).map("appConfig").find()}function n(t){return e.reduce(t,function(t,r,i){return e.isUndefined(r)?t:t.concat([i+"="+r])},[]).join("&")}function o(t,r){return t.publicModel?"/_api/wix-code-public-dispatcher/siteview":"//"+e.find(r,{type:"siteextension"}).instanceId+".dev."+t.serviceTopology.wixCloudBaseDomain}return{getUserCodeUrlsDetails:function(t,i){var n=[],o=e.find(t,function(e){return e.id===i&&"masterPage"!==e.type}),s=e.find(t,{id:i,type:"masterPage"});return s&&n.push(r(s)),o&&n.push(r(o)),n},getElementoryArguments:function(e,r,s,a){var u=i(s);if(u)return{baseUrl:o(e,r),queryParameters:n({scari:u.scari,instance:u.instance,viewMode:a}),options:{headers:{"X-XSRF-TOKEN":t.getCookie("XSRF-TOKEN")}}}}}}),define("platformInit/utils/urlBuilder",["lodash"],function(e){"use strict";function t(e){return e&&e.replace(/^https?\:/,"")}function r(r,i){var n=t(r);if(e.startsWith(n,i)){var o=n.slice(i.length).match(/\/?services\/santa\/([\w.]+)/);return o&&o[1]}}function i(e,i,n,o){if(e)return e;var s=t(o);return r(i,s)||r(n,s)}return{buildUrl:function(e,t){var r=t.runtimeSource,n=e.serviceTopology;return"/_partials/santa/"+i(r,e.santaBase,n.scriptsLocationMap.santa,n.scriptsDomainUrl)+"/node_modules/santa-wix-code/dist/wixcode-worker.js"}}}),define("platformInit/utils/FallbackStorage",[],function(){"use strict";return function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"setItem",value:function(e,t){this[e]=String(t)}},{key:"getItem",value:function(e){return this[e]||null}},{key:"removeItem",value:function(e){delete this[e]}},{key:"clear",value:function(){var e=this;Object.keys(this).forEach(function(t){return e.removeItem(t)})}},{key:"toJSON",value:function(){return this.storage.toJSON()}}]),e}()}),define("platformInit/utils/storageFacade",["lodash","platformInit/utils/FallbackStorage"],function(e,t){"use strict";function r(t){return e(t).pickBy(function(t,r){return e.startsWith(r,i)}).reduce(function(t,r,n){return e.assign(t,_defineProperty({},n.replace(i,""),r))},{})}var i="platform_app_";return{get:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0]?window:{localStorage:new t,sessionStorage:new t};return{serialize:function(){return JSON.stringify({local:r(e.localStorage),session:r(e.sessionStorage)})},setItem:function(t,r,n){e[t].setItem(i+r,n)}}}}}),define("platformInit/utils/messageBuilder",[],function(){"use strict";return{bootstrapMessage:function(e){return{type:"wix_code_worker_bootstrap",bootstrapArguments:e}},loadUserCodeMessage:function(e,t){return{type:"wix_code_worker_load_user_code",workerId:e,wixCode:t}},loadMessage:function(e,t,r,i,n,o,s,a){return{type:"wix_code_worker_load",workerId:e,elementoryArguments:t,wixCode:r,applications:i,sdkParameters:n,routersMap:o,lightboxContext:s,storage:a}},initMessage:function(e,t){return{type:"wix_code_worker_init",id:e,apps:t}},startMessage:function(e,t,r){return{type:"wix_code_worker_start",context:e,id:t,siteInfo:r}},storageWasUpdatedMessage:function(e){return{type:"storageWasUpdated",storageValue:e}},updateWixCodeModelDataAfterLoginMessage:function(e,t){return{type:"update_wix_code_model_data_after_login",workerId:e,elementoryArguments:t}}}}),define("platformInit/api/workerManager",["lodash","platformInit/utils/constants","platformInit/utils/wixCodeUrlUtils","platformInit/utils/urlBuilder","platformInit/utils/storageFacade","platformInit/utils/messageBuilder"],function(e,t,r,i,n,o){"use strict";function s(e){return e.publicModel?"site":e.renderFlags.componentViewMode||"preview"}function a(){return{viewMode:s(this._siteModel),locale:this._siteModel.rendererModel.languageCode,storage:this._storageManager.serialize()}}function u(t){"undefined"!=typeof window&&window.fetch&&e(t).filter(function(e){return!M[e.id]}).forEach(function(e){M[e.id]=!0,window.fetch(e.url)})}function c(){if(!this._standbyWorker){var e=new Worker(i.buildUrl(this._siteModel,this._options));e.onmessage=this.onmessage,this._standbyWorker=e,l.call(this,e)}}function l(){var e=this._options.applications,r=this._siteModel.serviceTopology.scriptsLocationMap["wix-code-platform"],i={id:"es6runtime",url:r+t.ES6_RUNTIME_PATH},n={id:"wixCodeRuntime",url:r+t.WIX_CODE_RUNTIME_PATH},s={id:"sdk",url:this._options.sdkSource},c={id:"semi-native-sdk",url:this._options.semiNativeSDKSource},l=this._options.ReactLibSource,d=this._options.ReactDomSource;u([s,i,n].concat(e)),this._standbyWorker.postMessage(o.bootstrapMessage({sdkParameters:a.call(this),debug:window.__WIX_CODE_DEBUG__,sdkSource:s.url,semiNativeSDKSource:c.url,reactDomSource:d,reactSource:l,applications:encodeURIComponent(JSON.stringify(e)),wixCodeScripts:[i,n]}))}function d(e){this._workers[e]=this._standbyWorker,this._reportWorkerCreated(e),this._standbyWorker=null}function p(t,i){return t.reduce(function(t,n){return e.assign(t,_defineProperty({},n,r.getUserCodeUrlsDetails(i,n)))},{})}function f(e){var t=this;Object.keys(e).forEach(function(r){var i=e[r];u(i),t.has(r)||(c.call(t),d.call(t,r)),t.send(r,o.loadUserCodeMessage(r,i))})}function g(e){var t=this._workers[e];return!!t&&(t.terminate(),delete this._workers[e],!0)}function m(e){var t=this,r=e.applications,i=e.rootIds,n=e.wixCodeScriptsByRootId,s=e.elementoryArguments,a=e.popupContexts,u=e.routersMap,l=e.sdkParameters;i.forEach(function(e){t.has(e)||(c.call(t),d.call(t,e)),t.send(e,o.loadMessage(e,s,n[e],r,l,u,a[e],t._storageManager.serialize()))})}function h(t){var r=this,i=t.type,n=t.key,s=t.value;this._storageManager.setItem(i,n,s);var a=o.storageWasUpdatedMessage(this._storageManager.serialize());e.forEach(this._workers,function(e,t){r.send(t,a)})}function w(t){var r=this;return function(i){var n=i.data;e.isMatch(n,{intent:"BROWSER_API",type:"setToStorage"})&&h.call(r,n.data),t(i)}}function _(r){return function(i){var n=i.data,o=i.ports;e.includes(t.PM_RPC_INTENTS,n.intent)&&window.postMessage(n,"*",o),r(i)}}var M={},v=function(){function t(e,r,i,n){_classCallCheck(this,t),this._siteModel=e,this._clientSpecMap=r,this._options=n,this._workers={},this._standbyWorker=null,this._storageManager=i}return _createClass(t,[{key:"has",value:function(e){return Boolean(this._workers[e])}},{key:"initialize",value:function(e,t,r){this.onmessage=_.call(this,w.call(this,function(t){var r=t.data;return e(r)})),this._reportWorkerCreated=t,this._reportWorkerTerminated=r,c.call(this)}},{key:"send",value:function(e,t,r){var i=this._workers[e];i&&(r?i.postMessage(t,r):i.postMessage(t))}},{key:"get",value:function(e){return this._workers[e]}},{key:"handleWidgetsCommand",value:function(t){var i=this;switch(t.type){case"load_user_code":f.call(this,p(t.rootIds,t.widgets));break;case"load_widgets":m.call(this,{applications:e.reject(t.widgets,e.overSome({type:"Page"},{type:"Popup"},{type:"masterPage"})),rootIds:t.rootIds,wixCodeScriptsByRootId:p(t.rootIds,t.widgets),elementoryArguments:r.getElementoryArguments(this._siteModel,this._clientSpecMap,t.widgets,s(this._siteModel)),popupContexts:t.popupContexts,routersMap:t.routersMap,sdkParameters:t.sdkParameters});break;case"init_widgets":e.forEach(t.contexts,function(e,t){if(!i.has(t))throw new Error("Context id "+t+" is not loaded");i.send(t,o.initMessage(t,e))});break;case"start_widgets":if(!t.contexts)throw new Error("Start message must contain contexts property");e.forEach(t.contexts,function(e,r){if(!i.has(r))throw new Error("Context id "+r+" is not loaded");i.send(r,o.startMessage(e,r,t.siteInfo))});break;case"trigger_onRender":c.call(this),this.send(t.contextId,t);break;case"stop_widgets":e.forEach(t.widgetIds,function(e){g.call(i,e)&&i._reportWorkerTerminated(e)});break;case"update_wix_code_model_data_after_login":e.forEach(t.rootIds,function(e){i.send(e,o.updateWixCodeModelDataAfterLoginMessage(e,r.getElementoryArguments(i._siteModel,i._clientSpecMap,t.widgets,s(i._siteModel))))});break;default:this.has(t.contextId)&&this.send(t.contextId,t)}}}]),t}();return{getWorkerManager:function(e,t,r,i){return new v(e,t,n.get(r),i)}}}),define("platformInit/utils/messageProxy",[],function(){"use strict";return{get:function(){var e=[],t=null;return{sendOrHoldMessage:function(r){t?t(r):e.push(r)},setMessageHandler:function(r){for(t=r;e.length>0;)t(e.shift())}}}}}),define("platformInit/utils/biUtils",["lodash"],function(e){"use strict";return{reportBiWithWixBiSession:function(e){var t=e.reportDef,r=e.params;t.errorCode?window.wixBiSession.sendError(t,r.p1,r.p2,r.p3,r.p4):window.wixBiSession.sendBI(t.endpoint,t.eventId,t.src,r)},shouldUseFallbackReportBI:function(t,r){return"WIX_CODE_SITE_API"===t.intent&&"reportBI"===t.type&&e.isEmpty(r)&&"undefined"!=typeof window}}}),define("platformInit/bi/events.json",[],function(){return{WORKER_CREATED:{endpoint:"platform-viewer",src:79,eventId:101,params:{worker_id:"worker_id"}},WORKER_TERMINATED:{endpoint:"platform-viewer",src:79,eventId:102,params:{worker_id:"worker_id"}}}}),define("platformInit/api/wixCodeAppApi",["lodash","platformInit/utils/widgetsPreLoader","platformInit/api/workerManager","platformInit/utils/messageProxy","platformInit/utils/biUtils","platformInit/bi/events.json"],function(e,t,r,i,n,o){"use strict";function s(t){var r=t.rendererModel.clientSpecMap.toJS?t.rendererModel.clientSpecMap.toJS():t.rendererModel.clientSpecMap;return t.rendererModel.wixCodeModel&&e.some(r,{type:"siteextension"})}function a(){try{return window.localStorage.setItem("",""),window.localStorage.removeItem(""),!0}catch(e){return!1}}return{getApi:function(){function u(e){n.shouldUseFallbackReportBI(e,d)&&n.reportBiWithWixBiSession(e),d.forEach(function(t){t(e)})}function c(e){return p.reduce(function(e,t){return t(e)},e)}var l=i.get(),d=[],p=[],f=!1,g=!1,m=!1,h=!1,w=void 0,_=void 0;return{init:function(e,t,i){f?console.warn("Wix code is already initiated"):(_=i.applications.length>0,(s(e)||_)&&((w=r.getWorkerManager(e,t,a(),i)).initialize(u,function(e){return n.reportBiWithWixBiSession({reportDef:o.WORKER_CREATED,params:{worker_id:e}})},function(e){return n.reportBiWithWixBiSession({reportDef:o.WORKER_TERMINATED,params:{worker_id:e}})}),l.setMessageHandler(function(e){return w.handleWidgetsCommand(e)}),f=!0))},sendMessage:function(e){e&&l.sendOrHoldMessage(c(e))},registerMessageHandler:function(e){d.push(e)},registerMessageModifier:function(e){p.push(e)},unregisterMessageHandler:function(t){e.pull(d,t)},preLoadWidgets:function(e,r){!g&&s(e)&&t.asyncGetPreLoadMessage(e,r,function(e){g||(g=!0,l.sendOrHoldMessage(e))})},preLoadUserCode:function(e,r){(!m&&s(e)||_)&&t.asyncGetPreLoadUserCodeMessage(e,r,function(e){m||(m=!0,l.sendOrHoldMessage(e))})},preInitWidgets:function(e,r){!h&&s(e)&&t.asyncGetPreInitMessage(e,r,function(e){h||(h=!0,l.sendOrHoldMessage(e))})},isAppInitiated:function(){return f},getWorkerById:function(e){return w&&w.get(e)}}}}}),define("platformInit/api/initMainR",["lodash","platformInit/utils/appsUtils"],function(e,t){"use strict";var r="//unpkg.parastorage.com/react@16.0.0/umd/react",i="//unpkg.parastorage.com/react-dom@16.0.0/umd/react-dom";return function(n,o,s,a,u,c,l){function d(t){return e.some(t,{type:"siteextension"})||I.applications.length}function p(e){return new e.FullSiteData(s,function(){})}function f(t,r){if(!r)return!1;var i=e.find(t.pageList.pages,{pageId:r});return!!i&&!i.pageJsonFileName}function g(e){var t=p(e);t.currentUrl=e.urlUtils.parseUrl(c);var r=e.wixUrlParser.parseUrl(t,c);return r&&r.pageId}function m(e,t,r){t&&!0!==r&&f(t,g(r))||(n.init(s,e,I),d(e)&&(n.preLoadUserCode(s,c),!!s.publicModel&&n.preLoadWidgets(s,c)))}c=c||window.document.location.href;var h=e.trimEnd(s.serviceTopology.scriptsLocationMap["js-wixcode-sdk"],"/")+"/lib/"+(u.getParameterByName("debug")?"wix.js":"wix.min.js"),w=e.trimEnd(s.serviceTopology.scriptsLocationMap["semi-native-sdk"],"/")+"/lib/wix.min.js",_=function(e){return"false"!==e&&("true"===e||!window.Worker||l)}(u.getParameterByName("useWixCodeFallback")),M=r+(u.getParameterByName("debug")?".development.js":".production.min.js"),v=i+(u.getParameterByName("debug")?".development.js":".production.min.js"),I={isMobileView:a,sdkSource:h,semiNativeSDKSource:w,runtimeSource:u.getParameterByName("WixCodeRuntimeSource"),ReactLibSource:M,ReactDomSource:v,useWixCodeFallback:_},y=u.getParameterByName("viewerPlatformAppSources");I.applications=t.getAppsBaseInfo({rendererModel:s.rendererModel,clientSpecMap:s.rendererModel.clientSpecMap,serviceTopology:s.serviceTopology,viewerPlatformAppSources:y,santaBase:s.santaBase}),function(){function t(e){m(s.rendererModel.clientSpecMap,s.publicModel,e)}!0===o||e.isObject(o)?t(o):requirejs.defined("utils")?t(requirejs("utils")):requirejs(["utils"],t)}()}}),define("platformInit/utils/specMapUtils",["lodash"],function(e){"use strict";return{getAppSpec:function(t,r){return e.find(t,{appDefinitionId:r})||e.find(t,{type:"siteextension"})}}}),define("platformInit",["platformInit/api/wixCodeAppApi","platformInit/api/initMainR","platformInit/utils/specMapUtils","platformInit/utils/appsUtils","platformInit/utils/widgetsPreLoader","platformInit/utils/messageProxy","platformInit/utils/biUtils"],function(e,t,r,i,n,o,s){"use strict";return{getAppApi:e.getApi,initMainR:t,specMapUtils:r,appsUtils:i,biUtils:s,widgetsPreLoader:n,registerDeps:n.registerDeps,messageProxy:o}});
//# sourceMappingURL=platformInit.min.js.map