define("userPreferences",["lodash","jquery","util","coreUtilsLib"],function(e,t,r,n){"use strict";var i=r.serviceTopology.premiumStateApiUrl,a=i?i.replace(/\/getTpaPremiumState/,"-user-preferences-webapp/"):"https://editor.wix.com/_api/wix-user-preferences-webapp/",o=!1;return function(){var i=null,s={session:{id:"session",data:{}},site:{id:"site",data:{},urls:{getLoadUrl:function(){return a+"getVolatilePrefsForSite/htmlEditor/"+i},getSaveUrl:function(){return a+"bulkSet"},getDeleteUrl:function(){return a+"delete"}}},global:{id:"global",data:null,urls:{getLoadUrl:function(){return a+"getVolatilePrefForKey/htmlEditor/global_preferences"},getSaveUrl:function(){return a+"set"}}}},l=function(){return r.url.isTrue("fakeUserPrefs")},u=function(t,r,n){return e.mapValues(t,function(t){return{value:e.isUndefined(n)?t:n,isDirty:r}})},f=function(t,i,a,o){s[t].data=i?function(t,r){switch(t){case s.global.id:return r.global_preferences;case s.site.id:return function(t){if(3===t.version)return u(t,!0);var r=e.assign({},e.omit(t,"editorAppId","version"),t.editorAppId);return p(t),r=e.transform(r,function(e,t,r){e[y("editorAppId",r)]=t},{}),r.version=3,u(r,!0)}(r);default:return n.log.error("unknown type ID"),{}}}(t,i):{},function(e){var t=r.url.getParameterByName("resetUserPrefs").toLowerCase();return"all"===t||t===e}(t)?b(t,a,o):a&&a()},c=function(t){t===s.site.id&&e.forEach(s.site.data,function(e){e.isDirty=!1})},d=function(e,r,n){if(l()){var i=window.sessionStorage.getItem("user_prefs_"+s[e].id);f(e,JSON.parse(i),r,n)}else t.ajax(s[e].urls.getLoadUrl(),{type:"GET",headers:{Accept:"application/json"},success:function(t){f(e,t,r,n)},error:function(e){n&&n(e)}})},p=function(t){return e.forEach(t,function(e,t){return g(t)})},g=function(e){l()||t.ajax(s[s.site.id].urls.getDeleteUrl(),{type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(function(e){return{nameSpace:"htmlEditor",key:e,siteId:i}}(e))})},b=function(e,t,r){switch(e){case s.global.id:return function(e,t){s.global.data={},v(s.global.id,e,t)}(t,r);case s.site.id:return function(e,t){s.site.data=u(s.site.data,!0,null),v(s.site.id,e,t)}(t,r)}},v=function(r,a,u){if(null!==s[r].data){if(l()){var f=function(t){switch(t){case s.global.id:return{global_preferences:s.global.data};case s.site.id:var r={};return e.forEach(s.site.data,function(e,t){r[t]=e.value}),r.version=3,r;default:return n.log.error("unknown type ID"),{}}}(r);return window.sessionStorage.setItem("user_prefs_"+s[r].id,JSON.stringify(f)),c(r),void(a&&a())}if(!o){var d=function(t){switch(t){case s.global.id:return{nameSpace:"htmlEditor",key:"global_preferences",blob:s.global.data};case s.site.id:return function(t){var r={nameSpace:"htmlEditor",siteId:i,data:{}};return e.forEach(t,function(e,t){e.isDirty&&(r.data[t]=e.value)}),r.data.version=3,r}(s.site.data)}}(r);d?t.ajax(s[r].urls.getSaveUrl(),{type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(d),success:function(){c(r),a&&a()},error:function(e){413===e.status&&(o=!0),u&&u(e)}}):a&&a()}}else u&&u("saving "+r+" preferences failed since they were not loaded")},y=function(e,t){return e+"_"+t};return{loadGlobalPreferences:function(){return new Promise(function(t,r){d(s.global.id,t,function(i){if(i&&i.responseText&&3001===e.get(JSON.parse(i.responseText),"errorCode"))return s.global.data={},void t();s.global.data=null,n.log.error("Global preferences failed to load!"),r("Global preferences failed to load!")})})},loadSitePreferences:function(t,r){return new Promise(function(a,o){var l=e.isEmpty(s.site.data);i=t;var u=e.partial(v,s.site.id,a,o);if(r)l||u();else if(l)d(s.site.id,u,function(){n.log.error("Site preferences failed to load!"),o("Site preferences failed to load!")});else{var f=e.clone(s.site.data);d(s.site.id,function(){s.site.data=e.merge(s.site.data,f),u()},function(){n.log.error("Site preferences failed to load!"),u()})}})},global:{get:function(t){if(null===s.global.data)return n.log.error("Global user preferences failed to load!"),null;if(!e.isString(t))throw new Error("Getting a global user preference expects a key of type string but received: "+t);return e.cloneDeep(s.global.data[t])},getAll:function(){return null===s.global.data?(n.log.error("Global user preferences failed to load!"),null):e.cloneDeep(s.global.data)},set:function(t,r){if(!e.isString(t))throw new Error("Setting a global user preference expects a key of type string but received: "+t);return new Promise(function(i,a){null===s.global.data?(n.log.error("Global user preferences failed to load!"),a("Global user preferences failed to load!")):(e.isUndefined(r)&&(r=null),s.global.data[t]=r,v(s.global.id,i,a))})}},site:{get:function(t,r){if(r=r||"editorAppId",!e.isString(t))throw new Error("Getting a user preference for the site expects a key of type string but received: "+t);var n=y(r,t);return e.cloneDeep(s.site.data[n]&&s.site.data[n].value)},getAll:function(){return function(t){return e.transform(s.site.data,function(e,r,n){var i=n.split("_");i[0]===t&&(e[i[1]]=r.value)},{})}("editorAppId")},set:function(t,r,n){if(!e.isString(t))throw new Error("Setting a user preference for the site expects a key of type string but received: "+t);return new Promise(function(a,o){n=n||"editorAppId",e.isUndefined(r)&&(r=null);var l={value:r,isDirty:!0};t=y(n,t),s.site.data[t]=l,i?v(s.site.id,a,o):a()})}},session:{get:function(t){if(!e.isString(t))throw new Error("Getting a session user preference expects a key of type string but received: "+t);return e.cloneDeep(s.session.data[t])},getAll:function(){return e.cloneDeep(s.session.data)},set:function(t,r){if(!e.isString(t))throw new Error("Setting a session user preference expects a key of type string but received: "+t);return s.session.data[t]=r,r}}}}});
//# sourceMappingURL=userPreferences.min.js.map